# ESP32 轮腿平衡机器人项目介绍（面向导师）

## 1. 项目概括
本项目是一个基于 **ESP32 + MPU6050 + CAN 总线** 的 **轮腿复合自平衡机器人**控制系统：在 FreeRTOS 多任务实时调度下，融合 **PID（腿长/横滚/偏航）+ LQR（整车平衡）+ VMC（虚拟模型控制）**，实现稳定站立、自平衡移动、跳跃与交叉步态等动作，并支持 **Xbox 蓝牙手柄**与**串口指令队列**控制。

## 2. 项目目标与动机
- **目标**：让轮腿机器人在平地稳定自平衡，并在保持平衡的同时完成前进/后退/转向，以及跳跃、交叉步展示等动作。
- **核心难点**：轮—腿系统耦合强（姿态、腿长、轮速、触地状态互相影响），需要高频姿态感知、快速闭环控制与可靠的动作/状态管理。

## 3. 系统构成（硬件与通信）
- **主控**：ESP32（Arduino 框架，PlatformIO 工程化构建）
- **姿态传感**：MPU6050（姿态角与角速度）
- **执行机构**：6 电机（4 关节电机 + 2 轮毂电机）
- **电机通信**：CAN（1Mbps），用于实时反馈与指令下发
- **交互方式**：
  - 蓝牙：Xbox 手柄（BLE）
  - 串口：命令/队列（可对接语音模块或上位机脚本）
- **电源与监测**：6S 锂电；使用 ADC（ADS1115）进行电压监测并用于输出补偿（工程实现中体现为电机输出比例动态调节的思路）

## 4. 软件架构与实时任务
项目采用“底层驱动 → 状态估计/运动学 → 控制 → 输入”的分层思路，并以 FreeRTOS 任务实现实时性：
- **CAN 接收任务**：高频轮询接收电机反馈，更新电机角度/速度等状态
- **电机下发任务**：周期性计算补偿后的驱动电压并通过 CAN 发送（典型 2ms 周期）
- **控制主环任务**：计算状态变量，执行 LQR/PID/VMC 并输出扭矩（典型 4ms 周期）
- **输入任务**：
  - Xbox 手柄处理任务（约 50Hz）
  - UART2 命令解析 + 队列执行任务（按序执行、可暂停/恢复/停止）

## 5. 控制与算法亮点（技术核心）
本项目控制核心可以概括为“三层组合”：
- **LQR（整车平衡）**：以状态向量 \((\theta,\dot\theta,x,\dot x,\phi,\dot\phi)\) 为基础，输出平衡所需的控制量；车轮电机扭矩以 LQR 输出为主，实现位移/速度/俯仰的稳定。
- **PID（辅助与约束）**：
  - **Yaw PID**：对偏航角/角速度闭环，LQR 输出与 yaw PID 叠加实现转向。
  - **Leg Length PID**：对虚拟腿长闭环，生成左右腿推力基值。
  - **Roll PID**：对横滚角闭环，通过左右腿推力差分实现横向稳定/偏置控制。
- **VMC（虚拟模型控制）**：将“虚拟腿推力/力矩”转换为两关节电机扭矩，完成力到关节驱动的映射，实现轮腿结构的协调控制。

此外还实现了关键工程保护与状态管理：
- **触地/离地检测**：基于支持力阈值判断触地状态，配合防抖与落地缓冲状态机，提升跳跃/落地稳定性。
- **离地策略**：离地时关闭轮电机输出、优先保持腿部姿态，避免空中失控。
- **角度保护与恢复逻辑**：当姿态或腿部角度越界时进行输出保护与延时恢复，提高安全性。

## 6. 交互系统与输入仲裁（可演示性）
为便于演示与扩展，项目支持两类控制输入，并做了仲裁避免“抢控制权”：
- **Xbox 手柄（BLE）即时控制**：
  - 左摇杆：前进/后退速度
  - 右摇杆：转向与腿长调节
  - 按键：平衡开关、起立、跳跃、交叉步切换等
- **串口指令队列（脚本化控制）**：
  - 支持 `FORWARD/BACKWARD/LEFT/RIGHT/STOP/JUMP/STANDUP/...`
  - 支持以 `;` 拼接复合命令并顺序执行
  - 队列运行/暂停时，自动抑制 BLE 对目标量的覆盖，实现“脚本优先”

## 7. 当前进度与成果（可答辩要点）
根据项目进度记录，已完成从“能动”到“能稳”再到“能表演”的闭环：
- CAN 通信、电机反馈/下发、多电机初始化与校准、参数持久化
- IMU 姿态获取与调试输出
- 级联 PID（腿长/横滚/偏航）框架
- LQR 平衡控制（含腿长相关的增益计算）
- VMC 转换与腿部运动学（由 MATLAB 生成并集成到工程）
- 触地检测、离地/落地缓冲、角度保护
- 动作能力：起立、跳跃、交叉步展示
- 交互能力：Xbox 手柄 BLE + 串口命令队列 + 输入仲裁

## 8. 建议的 1–2 分钟演示脚本（课堂/答辩）
- **稳定性**：上电→连接→开启平衡→轻推扰动后能回正。
- **运动性**：手柄控制前进/后退/转向，展示响应速度与稳定性。
- **动作性**：触发跳跃与交叉步；再用串口复合命令演示队列编排。

## 9. 后续可优化方向（导师常见追问）
- **控制参数整定流程工程化**：建立离线/在线标定工具链（参数版本管理、自动化扫描与回归测试）。
- **状态估计增强**：更鲁棒的滤波与传感器融合（抗震动、抗漂移）。
- **安全与可维护性**：完善急停/故障诊断、日志体系与异常自恢复策略。
- **地形适应**：更完善的触地判据与步态规划，让轮腿在不平整地面更稳定。

